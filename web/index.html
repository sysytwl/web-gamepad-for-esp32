<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>wifi gamepad</title>
    <style>
		canvas{
			display: block;
			margin: auto auto auto 1%;
            display: inline-block;
		}
        #mainTable {
            margin: auto 1% auto auto;
            display: inline-block;
        }
        .arrows {
            font-size:70px;

            color:rgb(9, 255, 0);
        }
        td.button {
            width: 90px;
            height: 90px;
            background-color:black;
            box-shadow: 3px 3px #3b446e;
        }
        td.button:active {
            transform: translate(3px, 3px);
            box-shadow: none; 
        }
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 25px;
            border-radius: 5px;
            background: #000000;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
	</style>
</head>
<body align="center">
<canvas id="canvas" width="600" height="600" style="border: 1px solid #888"></canvas>
<table id="mainTable" CELLSPACING=20>
    <tr>
        <td></td>
        <td class="button" ontouchstart='sendButtonInput(undefined, undefined, undefined, 255)' ontouchend='sendButtonInput(undefined, undefined, undefined, 128)' 
            onmousedown='sendButtonInput(undefined, undefined, undefined, 255)' onmouseup='sendButtonInput(undefined, undefined, undefined, 128)'>
          <span class="arrows">&#8679;</span>
        </td>
        <td></td>
      </tr>
      <tr>
        <td class="button" ontouchstart='sendButtonInput(undefined, undefined, 0)' ontouchend='sendButtonInput(undefined, undefined, 128)'
            onmousedown='sendButtonInput(undefined, undefined, 0)' onmouseup='sendButtonInput(undefined, undefined, 128)'>
          <span class="arrows">&#8678;</span>
        </td>
        <td class="button" onmousedown='sendButtonInput(0, 0, 128, 128, 128, 128, 128, 128)' onmouseup='sendButtonInput(0, 0, 128, 128, 128, 128, 128, 128)'>
          <span class="arrows">&#10539;</span>
        </td>
        <td class="button" ontouchstart='sendButtonInput(undefined, undefined, 255)' ontouchend='sendButtonInput(undefined, undefined, 128)'
            onmousedown='sendButtonInput(undefined, undefined, 255)' onmouseup='sendButtonInput(undefined, undefined, 128)'>
          <span class="arrows">&#8680;</span>
        </td>
      </tr>
      <tr>
        <td></td>
        <td class="button" ontouchstart='sendButtonInput(undefined, undefined, undefined, 0)' ontouchend='sendButtonInput(undefined, undefined, undefined, 128)' 
            onmousedown='sendButtonInput(undefined, undefined, undefined, 0)' onmouseup='sendButtonInput(undefined, undefined, undefined, 128)'>
          <span class="arrows">&#8681;</span>
        </td>
        <td></td>
      </tr>

    <tr>
      <td style="text-align:left;font-size:30px"><b>CH1:</b></td>
      <td colspan=2>
       <div class="slidecontainer"><input type="range" min="0" max="255" value="128" class="slider" oninput='sendButtonInput(undefined,undefined,undefined,undefined,value)'></div>
      </td>
    </tr>
    <tr>
      <td style="text-align:left;font-size:30px"><b>CH2:</b></td>
      <td colspan=2>
       <div class="slidecontainer"><input type="range" min="0" max="255" value="128" class="slider" oninput='sendButtonInput(undefined,undefined,undefined,undefined,undefined,value)'></div>
      </td>
    </tr>
    <tr>
        <td style="text-align:left;font-size:30px"><b>CH3:</b></td>
        <td colspan=2>
         <div class="slidecontainer"><input type="range" min="0" max="255" value="128" class="slider" oninput='sendButtonInput(undefined,undefined,undefined,undefined,undefined,value)'></div>
        </td>
    </tr>

    <tr>
        <td class="button" ontouchend='sendButtonInput(undefined,undefined,undefined,undefined,undefined,undefined,undefined,prevValues.ch4 - 5)'
            onclick='sendButtonInput(undefined,undefined,undefined,undefined,undefined,undefined,undefined,prevValues.ch4 + 5)'>
          <span class="arrows">&#8678;</span>
        </td>
        <td></td>
        <td class="button" ontouchend='sendButtonInput(undefined,undefined,undefined,undefined,undefined,undefined,undefined,prevValues.ch4 + 5)'
            onclick='sendButtonInput(undefined,undefined,undefined,undefined,undefined,undefined,undefined,prevValues.ch4 - 5)'>
          <span class="arrows">&#8680;</span>
        </td>
    </tr>
  </table>
</body>

<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
<script src='jquery.min.js'></script>
<script type="application/javascript">
    function gamepad() {
        let mousedown = false;
        let texturl = document.getElementById('url');
        let mycanvas = document.getElementById('canvas');
        let ctx = mycanvas.getContext('2d');

        let POS_X = 100;
        let POS_Y = 100;
        let SAMLL_CIRCUIT_R = 50;
        let BIG_CIRCUIT_R = 200;
        let output = {};

        function init() {
            joystickdraw(BIG_CIRCUIT_R + POS_X, BIG_CIRCUIT_R + POS_Y);
        }

        function getXY(x, y) {

            let mouse2centerlength = Math.sqrt(x * x + y * y);
            let newx = x;
            let newy = y;
            if (mouse2centerlength > BIG_CIRCUIT_R) {
                let proportion = mouse2centerlength / BIG_CIRCUIT_R;
                newx = x / proportion;
                newy = y / proportion;
            }
            return {x: newx, y: newy};
        }

        function joystickdraw(posx, posy) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            let pos = getXY(posx - POS_X - BIG_CIRCUIT_R, posy - POS_Y - BIG_CIRCUIT_R);
            output.x = parseInt(pos.x / BIG_CIRCUIT_R * 180);
            output.y = parseInt(pos.y / BIG_CIRCUIT_R * 180);
            sendButtonInput(output.x, output.y);
            $('#xvalue').text(output.x+","+output.y);

            ctx.translate(pos.x + POS_X + BIG_CIRCUIT_R - SAMLL_CIRCUIT_R, pos.y + POS_Y + BIG_CIRCUIT_R - SAMLL_CIRCUIT_R);
            ctx.beginPath();
            ctx.arc(SAMLL_CIRCUIT_R, SAMLL_CIRCUIT_R, SAMLL_CIRCUIT_R, 0, 2 * Math.PI);
            ctx.lineWidth = 10;
            ctx.fillStyle = 'black';
            ctx.fill();
            ctx.stroke();
            ctx.restore();
        }

        function dragstart_event(e) {
            mousedown = true;
            joystickdraw(e.offsetX, e.offsetY)
        }

        function dragging_event(e) {
            if (mousedown) {
                joystickdraw(e.offsetX, e.offsetY)
            }
        }

        function dragstop_event() {
            mousedown = false;
            init();
        }

        function touchstart_event(e) {
            mousedown = true;
            joystickdraw(e.touches[0].clientX, e.touches[0].clientY)
        }

        function touching_event(e) {
            if (mousedown) {
                joystickdraw(e.touches[0].clientX, e.touches[0].clientY)
            }
        }

        function touchstop_event() {
            mousedown = false;
            init();
        }

        mycanvas.onmousedown = dragstart_event;
        mycanvas.onmousemove = dragging_event;
        mycanvas.onmouseup = dragstop_event;

        mycanvas.ontouchstart = touchstart_event;
        mycanvas.ontouchmove = touching_event;
        mycanvas.ontouchend = touchstop_event;

        init();
    }
    
    var webSocketCarInputUrl = "ws:\/\/" + window.location.hostname + "/CarInput";
    //$("#url").attr("value",webSocketCarInputUrl);
    //var btnconnect = document.getElementById('connect');
    //var btndisconnect = document.getElementById('disconnect');
    var prevValues = {x: 0,y: 0,a: 128,b: 128,ch1: 128,ch2: 128,ch3: 128,ch4: 128,};

    function initCarInputWebSocket() {
        websocketCarInput = new WebSocket(webSocketCarInputUrl);

        websocketCarInput.onopen = function(event){
          gamepad();
        };
        websocketCarInput.onclose   = function(event){
            alert("Disconnect");
            setTimeout(initCarInputWebSocket, 1000);
        };
        websocketCarInput.onmessage = function(event){

        };        
    }
      
    function sendButtonInput(x = undefined, y = undefined, a = undefined, b = undefined, ch1 = undefined, ch2 = undefined, ch3 = undefined, ch4 = undefined) {
        let data = {
            x: x !== undefined ? x : prevValues.x,
            y: y !== undefined ? y : prevValues.y,
            a: a !== undefined ? a : prevValues.a,
            b: b !== undefined ? b : prevValues.b,
            ch1: ch1 !== undefined ? ch1 : prevValues.ch1,
            ch2: ch2 !== undefined ? ch2 : prevValues.ch2,
            ch3: ch3 !== undefined ? ch3 : prevValues.ch3,
            ch4: ch4 !== undefined ? ch4 : prevValues.ch4,
        };
        prevValues = data;
        websocketCarInput.send(data);
    }
    
    window.onload = initCarInputWebSocket;
    var mainTable = document.getElementById("mainTable");

    function preventDefaultHandler(event) {
        event.preventDefault();
    }

    // Add a touchend event listener
    mainTable.addEventListener("touchend", preventDefaultHandler);

    // Add a click event listener
    mainTable.addEventListener("click", preventDefaultHandler);
</script>
</html>
